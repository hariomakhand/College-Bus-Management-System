import React, { useState, useEffect } from 'react';\nimport { MapContainer, TileLayer, Marker, Popup, Polyline } from 'react-leaflet';\nimport L from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\nimport { MapPin, Navigation, Clock, Bus } from 'lucide-react';\n\n// Fix for default markers\ndelete L.Icon.Default.prototype._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',\n  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',\n  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',\n});\n\n// Custom bus icon\nconst busIcon = new L.Icon({\n  iconUrl: 'data:image/svg+xml;base64,' + btoa(`\n    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"#10B981\" width=\"32\" height=\"32\">\n      <path d=\"M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z\"/>\n    </svg>\n  `),\n  iconSize: [32, 32],\n  iconAnchor: [16, 32],\n  popupAnchor: [0, -32]\n});\n\nconst StudentBusTracker = ({ driverId, busNumber }) => {\n  const [busLocation, setBusLocation] = useState(null);\n  const [tripStatus, setTripStatus] = useState('idle');\n  const [lastUpdate, setLastUpdate] = useState(null);\n\n  useEffect(() => {\n    if (!driverId) return;\n\n    // Fetch initial location\n    const fetchLocation = async () => {\n      try {\n        const response = await fetch(`http://localhost:5001/api/driver/location/${driverId}`);\n        const data = await response.json();\n        if (data.success) {\n          setBusLocation(data.data.location);\n          setTripStatus(data.data.tripStatus);\n          setLastUpdate(new Date(data.data.lastUpdate));\n        }\n      } catch (error) {\n        console.error('Failed to fetch driver location:', error);\n      }\n    };\n\n    fetchLocation();\n\n    // Set up WebSocket for real-time updates\n    const ws = new WebSocket('ws://localhost:5001');\n    \n    ws.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n      if (data.type === 'driverLocationUpdate' && data.driverId === driverId) {\n        setBusLocation(data.location);\n        setTripStatus(data.tripStatus);\n        setLastUpdate(new Date());\n      } else if (data.type === 'tripEnded' && data.driverId === driverId) {\n        setTripStatus('ended');\n        setBusLocation(null);\n      }\n    };\n\n    // Polling fallback\n    const interval = setInterval(fetchLocation, 30000); // Every 30 seconds\n\n    return () => {\n      ws.close();\n      clearInterval(interval);\n    };\n  }, [driverId]);\n\n  const defaultCenter = [28.6139, 77.2090]; // Default to Delhi\n  const mapCenter = busLocation ? [busLocation.lat, busLocation.lng] : defaultCenter;\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Status Header */}\n      <div className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg\">\n        <div className=\"flex items-center space-x-4\">\n          <div className={`w-3 h-3 rounded-full ${\n            tripStatus === 'active' ? 'bg-green-500 animate-pulse' : \n            tripStatus === 'ended' ? 'bg-red-500' : 'bg-gray-400'\n          }`}></div>\n          <span className=\"font-medium text-gray-700\">\n            Bus {busNumber} - {tripStatus === 'active' ? 'On Route' : \n                              tripStatus === 'ended' ? 'Trip Completed' : 'Not Started'}\n          </span>\n          {lastUpdate && (\n            <span className=\"text-sm text-gray-500\">\n              Last seen: {lastUpdate.toLocaleTimeString()}\n            </span>\n          )}\n        </div>\n        \n        <div className=\"flex items-center space-x-2 text-sm text-gray-600\">\n          <Navigation size={16} />\n          <span>Live Tracking</span>\n        </div>\n      </div>\n\n      {/* Map */}\n      <div className=\"h-80 rounded-lg overflow-hidden border\">\n        <MapContainer\n          center={mapCenter}\n          zoom={13}\n          style={{ height: '100%', width: '100%' }}\n        >\n          <TileLayer\n            url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n            attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n          />\n          \n          {/* Live Bus Location */}\n          {busLocation && (\n            <Marker position={[busLocation.lat, busLocation.lng]} icon={busIcon}>\n              <Popup>\n                <div className=\"text-center\">\n                  <strong>Your Bus ({busNumber})</strong>\n                  <br />\n                  <span className=\"text-sm text-gray-600\">\n                    Status: {tripStatus}\n                  </span>\n                  <br />\n                  <span className=\"text-xs text-gray-500\">\n                    {new Date(busLocation.timestamp).toLocaleString()}\n                  </span>\n                </div>\n              </Popup>\n            </Marker>\n          )}\n        </MapContainer>\n      </div>\n\n      {/* Location Info */}\n      {busLocation ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div className=\"bg-green-50 p-4 rounded-lg\">\n            <div className=\"flex items-center space-x-2 mb-2\">\n              <MapPin className=\"text-green-600\" size={20} />\n              <span className=\"font-medium text-gray-700\">Current Location</span>\n            </div>\n            <p className=\"text-sm text-gray-600\">\n              Lat: {busLocation.lat.toFixed(4)}, Lng: {busLocation.lng.toFixed(4)}\n            </p>\n          </div>\n          \n          <div className=\"bg-blue-50 p-4 rounded-lg\">\n            <div className=\"flex items-center space-x-2 mb-2\">\n              <Bus className=\"text-blue-600\" size={20} />\n              <span className=\"font-medium text-gray-700\">Bus Status</span>\n            </div>\n            <p className=\"text-sm text-gray-600 capitalize\">{tripStatus}</p>\n          </div>\n          \n          <div className=\"bg-purple-50 p-4 rounded-lg\">\n            <div className=\"flex items-center space-x-2 mb-2\">\n              <Clock className=\"text-purple-600\" size={20} />\n              <span className=\"font-medium text-gray-700\">Last Update</span>\n            </div>\n            <p className=\"text-sm text-gray-600\">\n              {new Date(busLocation.timestamp).toLocaleTimeString()}\n            </p>\n          </div>\n        </div>\n      ) : (\n        <div className=\"bg-gray-50 p-8 rounded-lg text-center\">\n          <Bus size={48} className=\"mx-auto mb-4 text-gray-400\" />\n          <h3 className=\"text-lg font-medium text-gray-700 mb-2\">Bus Location Not Available</h3>\n          <p className=\"text-gray-500\">The driver hasn't started the trip yet or location sharing is disabled.</p>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default StudentBusTracker;